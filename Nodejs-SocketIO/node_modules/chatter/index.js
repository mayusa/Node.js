var all_sockets = null;

var users = [];
exports.set_sockets = function (sockets) {
	all_sockets = sockets;
};
//config: object
exports.connect_chatter = function (config) {

	config.socket.on('user login', function (data){
		config.username = data.username;
		users.push({'name':data.username,'id':config.socket.id});
		all_sockets.emit('allUsers',{users:users});
		all_sockets.emit('chat message', {message: 'new user ' + data.username + ' has log in.', username: 'system'});
		config.socket.emit('chat message', {message: 'Welcome~ ' + data.username, username: 'system'});
	});

	config.socket.on('disconnect', function (){
		all_sockets.emit('exit', {message: config.username + ' has disconnected.', username: 'system'});
		for (var i = 0; i < users.length; i++) {
			if(users[i].id === config.socket.id){				
				users.splice(i,1);
				break;
			}
		};
		all_sockets.emit('allUsers',{users:users});
	});

	config.socket.on('chat message', function (data){
		all_sockets.emit('chat message', {message: data.message, username: data.username});
	});

};

exports.failure = function (socket){
	socket.emit('error', {message: 'please login to the chat room.'});
};